"use strict";define(function(require,exports,module){var merge=require("js/lib/merge.js"),message=function(_ref){var success=_ref.success,msg=_ref.msg,result=_ref.result,total=_ref.total;return{success:success,msg:msg,result:result,total:total}},dbHelper=function(){this.localDatabase={},this.localDatabase.indexedDB=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB,this.localDatabase.IDBKeyRange=window.IDBKeyRange||window.webkitIDBKeyRange,this.localDatabase.IDBTransaction=window.IDBTransaction||window.webkitIDBTransaction,this.localDatabase.indexedDB.onerror=function(e){alert("Database error: "+e.target.errorCode)}};dbHelper.prototype.openDatabase=function(dbName,storeName,version,callback){var me=this,vs=1;try{version&&(vs=version);var openRequest=me.localDatabase.indexedDB.open(dbName,vs);openRequest.onerror=function(e){callback&&callback(new message({success:!1,msg:"Database error: "+e.target.errorCode,result:null}))},openRequest.onsuccess=function(e){me.localDatabase.db=e.target.result,callback&&callback(new message({success:!0,msg:"createObjectStore success",result:null}))},openRequest.onupgradeneeded=function(e){me.localDatabase.db=e.target.result,me.createObjectStore(storeName,!1,!1,function(){callback&&callback(new message({success:!0,msg:"upgradeneeded success",result:null}))})}}catch(e){callback&&callback(new message({success:!1,msg:e,result:null}))}},dbHelper.prototype.distoryDatabase=function(dbName,callback){var _this=this;try{!function(){var me=_this,deleteDbRequest=me.localDatabase.indexedDB.deleteDatabase(dbName);deleteDbRequest.onsuccess=function(e){callback&&callback(new message({success:!0,msg:"Database deleted",result:null})),deleteDbRequest.onerror=function(e){callback&&callback(new message({success:!1,msg:"Database error: "+e.target.errorCode,result:null}))}}}()}catch(e){callback&&callback(new message({success:!1,msg:e,result:null}))}},dbHelper.prototype.createObjectStore=function(storeName,keyPath,valIndex,callback){try{var _me=this,def={keyPath:"id",autoIncrement:!0},kp=merge(def,keyPath||{}),employeeStore=_me.localDatabase.db.createObjectStore(storeName,kp);if(valIndex)for(var i=0;i<valIndex.length;i++){var index=valIndex[i];employeeStore.createIndex(index.name,index.feild,{unique:index.unique})}employeeStore.onsuccess=function(e){callback&&callback(new message({success:!0,msg:"ok",result:null}))}}catch(e){callback&&callback(new message({success:!1,msg:e,result:null}))}},dbHelper.prototype.find=function(storeName,whereObj,isFuzzy,topNum,callback){"function"==typeof whereObj?(callback=whereObj,whereObj=null,isFuzzy=null,topNum=null):"function"==typeof isFuzzy?(callback=isFuzzy,isFuzzy=null,topNum=null):"function"==typeof topNum&&(callback=topNum,topNum=null);try{var _me2=this,transaction=_me2.localDatabase.db.transaction(storeName,"readwrite"),_store=transaction.objectStore(storeName);if(null!=_me2.localDatabase&&null!=_me2.localDatabase.db){var request=(_me2.localDatabase.db.transaction(storeName).objectStore(storeName),_store.openCursor()),result=[],res=[];request.onsuccess=function(e){var cursor=e.target.result;if(cursor){var data=cursor.value;result.push(data),cursor["continue"]()}else{if(whereObj)for(var i=0;i<result.length;i++)for(var key in whereObj){var value=result[i][key];if("object"==typeof whereObj[key]){var obj=whereObj[key];if("date"==obj.type){var val1=new Date(obj.value),val2=new Date(value);if(!(val2>=val1)){delete result[i];break}}else if(isFuzzy){if(-1==value.indexOf(whereObj[key])){delete result[i];break}}else if(whereObj[key]!=value){delete result[i];break}}else if(isFuzzy){if(-1==value.indexOf(whereObj[key])){delete result[i];break}}else if(whereObj[key]!=value){delete result[i];break}}for(var _i=0;_i<result.length;_i++)result[_i]&&res.push(result[_i]);topNum&&res.length>topNum&&res.splice(topNum-1,res.length-topNum),callback&&callback(new message({success:!0,total:result.length,msg:"find success",result:result}))}}}}catch(e){callback&&callback(new message({success:!1,msg:e,result:null}))}},dbHelper.prototype.getById=function(storeName,id,callback){try{var _me3=this,transaction=_me3.localDatabase.db.transaction(storeName,"readwrite"),store=transaction.objectStore(storeName);null!=_me3.localDatabase&&null!=_me3.localDatabase.db&&(store.get(id).onsuccess=function(e){callback&&callback(new message({success:!0,msg:"ok",result:e.target.result}))})}catch(e){callback&&callback(new message({success:!1,msg:e,result:null}))}},dbHelper.prototype.add=function(storeName,fieldArr,callback){try{var _me4=this,transaction=_me4.localDatabase.db.transaction(storeName,"readwrite"),store=transaction.objectStore(storeName);if(null!=_me4.localDatabase&&null!=_me4.localDatabase.db)for(var i=0;i<fieldArr.length;i++){var obj=fieldArr[i],request=store.add(obj);request.onsuccess=function(e){callback&&callback(new message({success:!0,msg:"ok",result:null}))},request.onerror=function(e){callback&&callback(new message({success:!1,msg:e,result:null}))}}}catch(e){callback&&callback(new message({success:!1,msg:e,result:null}))}},dbHelper.prototype.deleteById=function(storeName,id,callback){try{var _me5=this;if(null!=_me5.localDatabase&&null!=_me5.localDatabase.db){var store=_me5.localDatabase.db.transaction(storeName,"readwrite").objectStore(storeName);store["delete"](id).onsuccess=function(e){callback&&callback(new message({success:!0,msg:"ok",result:null}))}}}catch(e){callback&&callback(new message({success:!1,msg:e,result:null}))}},dbHelper.prototype.clear=function(storeName,callback){try{if(null!=me.localDatabase&&null!=me.localDatabase.db){var store=me.localDatabase.db.transaction(storeName,"readwrite").objectStore(storeName);store.clear().onsuccess=function(e){callback&&callback(new message({success:!0,msg:storeName+" object store cleared",result:null}))}}}catch(e){callback&&callback(new message({success:!1,msg:e,result:null}))}},dbHelper.prototype.updateById=function(storeName,id,setObj,callback){var _this2=this;try{!function(){var me=_this2,transaction=me.localDatabase.db.transaction(storeName,"readwrite"),store=transaction.objectStore(storeName),record=void 0;null!=me.localDatabase&&null!=me.localDatabase.db&&(store.get(id).onsuccess=function(e){record=e.target.result;for(var key in setObj)(record[key]||""==record[key])&&(record[key]=setObj[key]);var request=store.put(record);request.onsuccess=function(es){if(callback){var result=[];result.push(record),callback(new message({success:!0,msg:storeName+" store  "+JSON.stringify(record)+"  update",result:result}))}},request.onerror=function(er){callback&&callback(new message({success:!1,msg:er,result:null}))}})}()}catch(e){callback&&callback(new message({success:!1,msg:e,result:null}))}},module.exports=dbHelper});
//# sourceMappingURL=IndexDBHelper.js.map